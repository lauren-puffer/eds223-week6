---
title: "True/False color imagery"
author: "Lauren Puffer"
format: html
editor: visual
---

## Load packages

```{r}
library(tidyverse)
library(sf)
library(terra)
library(tmap)
library(tmaptools)
```

## Load landsat data

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

```{r}
# load prefire image
# Set directory for folder
pre_fire_dir <- here::here("data", "LC80340322016189-SC20170128091153")

# Create a list of all images that have the extension .tif and contain the word band
pre_fire_bands <- list.files(pre_fire_dir,
                             pattern = glob2rx("*band*.tif$"),
                             full.names = TRUE)
# Create a raster stack
pre_fire_rast <- rast(pre_fire_bands)

# Read mask raster
pre_mask <- rast(here::here("data", "LC80340322016189-SC20170128091153", "LC80340322016189LGN00_cfmask_crop.tif"))


# load post-fire image
# Set directory for folder
post_fire_dir <- here::here("data", "LC80340322016205-SC20170127160728")

# Create a list of all images that have the extension .tif and contain the word band
post_fire_bands <- list.files(post_fire_dir,
                             pattern = glob2rx("*band*.tif$"),
                             full.names = TRUE)

# Create a raster stack
post_fire_rast <- rast(post_fire_bands)

# Read mask raster
post_mask <- rast(here::here("data", "LC80340322016189-SC20170128091153", "LC80340322016189LGN00_cfmask_crop.tif"))
```

## Normalized burn ratio function

```{r}
nbr_fun <- function(nir, swir2){
    (nir - swir2)/(nir + swir2)
}
```

## Rename and mask

Begin by renaming bands to correspond with what they represent.

```{r}
# Rename bands
bands <- c("Aerosol", "Blue", "Green", "Red", "NIR", "SWIR1", "SWIR2")
names(pre_fire_rast) <- bands
names(post_fire_rast) <- bands
```

Mask bands so that anything \>0 is an NA.

```{r}
# Set all cells with values greater than 0 to NA
pre_mask[pre_mask > 0] <- NA

# Subset raster based on mask
pre_fire_rast <- mask(pre_fire_rast, mask = pre_mask)

# View raster
plot(pre_fire_rast)
```

The prefire raster with NAs for any values over zero for Nir, Swir, aerosol, etc.

Now, we will do the same for the post fire mask.

```{r}
# Set all cells with values greater than 0 to NA
post_mask[post_mask > 0] <- NA

# Subset raster based on mask
post_fire_rast <- mask(post_fire_rast, mask = post_mask)

# View raster
plot(post_fire_rast)
```

## Make a histogram for stretch

Difference between the choice to use linear or histogram depends on the homogeneity of the landscape. Areas with landscapes that are gradients would be best suited for linear stretches, while ares with stark contrasts like canyons are best suited for histogram stretches.

```{r}
# View histogram for each band
hist(pre_fire_rast,
     maxpixels = ncell(pre_fire_rast),
     col = "orange")
```

## Make true color imagery

Map red to red, green to green, blue to blue for pre fire raster.

```{r}
plotRGB(pre_fire_rast, r = 4, g = 3, b = 2, stretch = "lin", colNA = "black")
```

Map red to red, green to green, blue to blue for post fire raster.

```{r}
plotRGB(post_fire_rast, r = 4, g = 3, b = 2, stretch = "lin", colNA = "black")
```

## Make false color imagery

Map the SWIR2 band to the red channel, NIR to green, and green to blue.

```{r}
plotRGB(pre_fire_rast, r = 7, g = 5, b = 3, stretch = "lin", colNA = "black")
```

Map the SWIR2 band to the red channel, NIR to green, and green to blue.

```{r}
plotRGB(post_fire_rast, r = 7, g = 5, b = 3, stretch = "lin", colNA = "black")
```

## Calculate the normalized burn ratio (NBR)

```{r}
# pre fire raster
nbr_pre_rast <- lapp(pre_fire_rast[[c(5,7)]], fun = nbr_fun)

# post fire raster
nbr_post_rast <- lapp(post_fire_rast[[c(5,7)]], fun = nbr_fun)

```

Plot pre-fire NBR raster.

```{r}
plot(nbr_pre_rast, main = "Cold Springs Pre-Fire NBR", colNA = "black")

```

Plot NBR postfire raster.

```{r}
plot(nbr_post_rast, main = "Cold Springs Post-Fire NBR", colNA = "black")

```

## Get the difference of the two rasters

```{r}
# subtract post from pre
dNBR <- nbr_pre_rast - nbr_post_rast

# load tmaptools
library(tmaptools)

# plot the difference
tm_shape(dNBR) +
  tm_raster(style = "equal", n = 6, 
            palette = "YlGnBu",
            title = "Difference NBR (dNBR)", colorNA = "black") +
  tm_layout(legend.outside = TRUE)
```

## Bonus: Classify the severity

```{r}
# use classify() to make a table of burn severity
categories <- c("Enhanced Regrowth", "Unburned", "Low Severity", 
                "Moderate Severity", "High Severity")

# matrix for reclassification
reclass <- matrix(c(-Inf, -0.1, 1, # group 1 ranges for Enhanced Regrowth
                -0.1, 0.1, 2, # group 2 ranges for Unburned
                0.1, 0.27, 3, # group 3 ranges for Low Severity
                0.27, 0.66, 4, # group 4 ranges for Moderity Severity
                0.66, Inf, 5), # group 5 ranges for High Severity
                ncol = 3, byrow = TRUE)

# use reclaissification matrix with difference raster
reclassified <- classify(dNBR, rcl = reclass)

# assign NAs to reclassified matrix
reclassified[is.nan(reclassified)] <- NA
```

Plot the reclassified raster.

```{r}
tm_shape(reclassified)+
  tm_raster(style = "equal", n = 6, 
            labels = c(categories, "Missing"),
            palette = "YlGnBu",
            title = "Burn Severity", colorNA = "black")+
  tm_layout(legend.outside = TRUE)
```
